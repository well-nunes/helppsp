<script>
(function() {
  // Criar elementos de UI
  var container = document.createElement('div');
  container.style.cssText = 'max-width:800px; margin:20px auto; font-family:Arial, sans-serif; border:1px solid #eee; padding:15px; border-radius:5px;';
  
  var heading = document.createElement('h3');
  heading.textContent = 'Busca no Conteúdo';
  heading.style.cssText = 'margin-top:0; color:#333;';
  
  var searchBox = document.createElement('div');
  searchBox.style.cssText = 'display:flex; margin:15px 0;';
  
  var input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Digite o que procura...';
  input.style.cssText = 'flex-grow:1; padding:8px; border:1px solid #ddd; border-radius:4px;';
  
  var button = document.createElement('button');
  button.textContent = 'Buscar';
  button.style.cssText = 'margin-left:8px; padding:8px 16px; background:#0078d4; color:white; border:none; border-radius:4px; cursor:pointer;';
  
  var statusDiv = document.createElement('div');
  statusDiv.style.cssText = 'margin:10px 0; font-size:14px; display:none;';
  
  var resultsDiv = document.createElement('div');
  resultsDiv.style.cssText = 'margin-top:15px;';
  
  // Montar a estrutura
  searchBox.appendChild(input);
  searchBox.appendChild(button);
  
  container.appendChild(heading);
  container.appendChild(searchBox);
  container.appendChild(statusDiv);
  container.appendChild(resultsDiv);
  
  // Adicionar ao DOM
  document.currentScript.parentNode.insertBefore(container, document.currentScript);
  
  // Função de busca
  function doSearch() {
    var term = input.value.trim();
    
    if (!term) {
      alert('Por favor, digite um termo para pesquisar.');
      input.focus();
      return;
    }
    
    // Status
    statusDiv.textContent = 'Pesquisando...';
    statusDiv.style.display = 'block';
    
    // Obter conteúdo da página
    var content = document.body.textContent || '';
    
    // Escapar regex
    function escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    try {
      // Criar regex
      var regex = new RegExp(escapeRegex(term), 'gi');
      
      // Encontrar ocorrências
      var matches = [];
      var match;
      var contexts = [];
      
      while ((match = regex.exec(content)) !== null) {
        var start = Math.max(0, match.index - 40);
        var end = Math.min(content.length, match.index + term.length + 60);
        var context = content.substring(start, end);
        
        // Adicionar elipses
        if (start > 0) context = '...' + context;
        if (end < content.length) context += '...';
        
        // Verificar se já temos um contexto similar
        var isDuplicate = contexts.some(function(ctx) {
          return ctx.indexOf(match[0]) !== -1 && 
                Math.abs(ctx.length - context.length) < 30;
        });
        
        if (!isDuplicate) {
          contexts.push(context);
          matches.push({
            text: context,
            position: match.index
          });
        }
      }
      
      // Mostrar resultados
      statusDiv.textContent = matches.length + ' resultado(s) encontrado(s)';
      
      if (matches.length === 0) {
        resultsDiv.innerHTML = '<div style="padding:15px; text-align:center; color:#666; border:1px solid #eee;">Nenhum resultado encontrado para "' + term + '"</div>';
      } else {
        var html = '';
        
        for (var i = 0; i < matches.length; i++) {
          var highlightedText = matches[i].text.replace(
            new RegExp('(' + escapeRegex(term) + ')', 'gi'),
            '<span style="background-color:#ffffa0; font-weight:bold;">$1</span>'
          );
          
          html += '<div style="padding:10px; margin-bottom:10px; border:1px solid #eee; background:#f9f9f9;">' +
                  highlightedText + '</div>';
        }
        
        resultsDiv.innerHTML = html;
      }
    } catch (error) {
      statusDiv.textContent = 'Erro na pesquisa';
      resultsDiv.innerHTML = '<div style="padding:15px; text-align:center; color:#c00; border:1px solid #fcc; background:#fff6f6;">Ocorreu um erro ao realizar a pesquisa.</div>';
      console.error('Erro na busca:', error);
    }
  }
  
  // Adicionar eventos
  button.addEventListener('click', doSearch);
  
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      doSearch();
    }
  });
  
  // Focar no input
  setTimeout(function() {
    input.focus();
  }, 100);
})();
</script>
